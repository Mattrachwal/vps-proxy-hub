 │ VPS Proxy Hub - Redundant Code Consolidation Plan                              │ ││ │                                                                                │ ││ │ 🔍 Redundant Code Patterns Identified                                          │ ││ │                                                                                │ ││ │ 1. Duplicated add_peer_to_config Function                                      │ ││ │                                                                                │ ││ │ - Files: tools/add-peer-key.sh and vps/scripts/04-wireguard-config.sh          │ ││ │ - Issue: Identical function duplicated in both files                           │ ││ │ - Solution: Move to shared/utils.sh or create shared/wireguard_utils.sh        │ ││ │                                                                                │ ││ │ 2. Duplicated Logging Functions                                                │ ││ │                                                                                │ ││ │ - Files: tools/remove-site.sh and tools/status.sh                              │ ││ │ - Issue: Both redefine logging functions despite sourcing shared/utils.sh      │ ││ │ - Solution: Remove local log function definitions, use shared ones             │ ││ │                                                                                │ ││ │ 3. WireGuard Installation Functions                                            │ ││ │                                                                                │ ││ │ - Files: vps/scripts/03-wireguard-install.sh and                               │ ││ │ home/scripts/01-wireguard-install.sh                                           │ ││ │ - Functions: install_wireguard(), setup_wireguard_directories(),               │ ││ │ enable_wireguard_module()                                                      │ ││ │ - Issue: Nearly identical implementations with minor differences               │ ││ │ - Solution: Create shared/wireguard_utils.sh with parameterized functions      │ ││ │                                                                                │ ││ │ 4. Peer Configuration Parsing                                                  │ ││ │                                                                                │ ││ │ - Files: Multiple files use inline yq commands for peer parsing                │ ││ │ - Issue: Raw yq commands scattered across files instead of using shared        │ ││ │ functions                                                                      │ ││ │ - Solution: Standardize on get_peer_config() from shared/utils.sh              │ ││ │                                                                                │ ││ │ 5. Redundant Utils Files                                                       │ ││ │                                                                                │ ││ │ - Files: vps/scripts/utils.sh and home/scripts/utils.sh                        │ ││ │ - Issue: Both just redirect to shared/utils.sh with minimal additions          │ ││ │ - Solution: Remove and update scripts to source shared/utils.sh directly       │ ││ │                                                                                │ ││ │ 🛠️ Consolidation Action                                                        │ │
│ │                                                                                │ ││ │ Phase 1: Create Shared WireGuard Utilities                                     │ ││ │                                                                                │ ││ │ - Create shared/wireguard_utils.sh                                             │ ││ │ - Move add_peer_to_config, install_wireguard, setup_wireguard_directories      │ ││ │ functions                                                                      │ ││ │ - Parameterize functions to handle VPS vs Home differences                     │ ││ │                                                                                │ ││ │ Phase 2: Fix Logging Redundancy                                                │ ││ │                                                                                │ ││ │ - Remove duplicated log functions from tools/remove-site.sh and                │ ││ │ tools/status.sh                                                                │ ││ │ - Ensure all tools use shared logging functions consistently                   │ ││ │                                                                                │ ││ │ Phase 3: Standardize Configuration Parsing                                     │ ││ │                                                                                │ ││ │ - Replace inline yq commands with shared utility functions                     │ ││ │ - Ensure consistent error handling and fallback parsing                        │ ││ │                                                                                │ ││ │ Phase 4: Remove Redundant Utils Files                                          │ ││ │                                                                                │ ││ │ - Remove vps/scripts/utils.sh and home/scripts/utils.sh                        │ ││ │ - Update all scripts to source shared/utils.sh directly                        │ ││ │                                                                                │ ││ │ Phase 5: Code Review and Testing                                               │ ││ │                                                                                │ ││ │ - Verify all functionality works after consolidation                           │ ││ │ - Test both VPS and home setup scripts                                         │ ││ │ - Test all tools (add-site, remove-site, status, add-peer-key)                 │ ││ │                                                                                │ ││ │ 📊 Expected Benefits                                                           │ ││ │                                                                                │ ││ │ - Reduced Code: ~200-300 lines of duplicated code removed                      │ ││ │ - Better Maintainability: Single source of truth for shared functions          │ ││ │ - Consistency: All scripts use identical logic for common operations           │ ││ │ - Easier Debugging: Issues fixed in one place benefit all scripts              │ ││ │                                                                                │ ││ │ This plan will significantly clean up the codebase while maintaining all       │ ││ │ existing functionality.   