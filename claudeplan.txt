 â”‚ VPS Proxy Hub - Redundant Code Consolidation Plan                              â”‚ â”‚â”‚ â”‚                                                                                â”‚ â”‚â”‚ â”‚ ğŸ” Redundant Code Patterns Identified                                          â”‚ â”‚â”‚ â”‚                                                                                â”‚ â”‚â”‚ â”‚ 1. Duplicated add_peer_to_config Function                                      â”‚ â”‚â”‚ â”‚                                                                                â”‚ â”‚â”‚ â”‚ - Files: tools/add-peer-key.sh and vps/scripts/04-wireguard-config.sh          â”‚ â”‚â”‚ â”‚ - Issue: Identical function duplicated in both files                           â”‚ â”‚â”‚ â”‚ - Solution: Move to shared/utils.sh or create shared/wireguard_utils.sh        â”‚ â”‚â”‚ â”‚                                                                                â”‚ â”‚â”‚ â”‚ 2. Duplicated Logging Functions                                                â”‚ â”‚â”‚ â”‚                                                                                â”‚ â”‚â”‚ â”‚ - Files: tools/remove-site.sh and tools/status.sh                              â”‚ â”‚â”‚ â”‚ - Issue: Both redefine logging functions despite sourcing shared/utils.sh      â”‚ â”‚â”‚ â”‚ - Solution: Remove local log function definitions, use shared ones             â”‚ â”‚â”‚ â”‚                                                                                â”‚ â”‚â”‚ â”‚ 3. WireGuard Installation Functions                                            â”‚ â”‚â”‚ â”‚                                                                                â”‚ â”‚â”‚ â”‚ - Files: vps/scripts/03-wireguard-install.sh and                               â”‚ â”‚â”‚ â”‚ home/scripts/01-wireguard-install.sh                                           â”‚ â”‚â”‚ â”‚ - Functions: install_wireguard(), setup_wireguard_directories(),               â”‚ â”‚â”‚ â”‚ enable_wireguard_module()                                                      â”‚ â”‚â”‚ â”‚ - Issue: Nearly identical implementations with minor differences               â”‚ â”‚â”‚ â”‚ - Solution: Create shared/wireguard_utils.sh with parameterized functions      â”‚ â”‚â”‚ â”‚                                                                                â”‚ â”‚â”‚ â”‚ 4. Peer Configuration Parsing                                                  â”‚ â”‚â”‚ â”‚                                                                                â”‚ â”‚â”‚ â”‚ - Files: Multiple files use inline yq commands for peer parsing                â”‚ â”‚â”‚ â”‚ - Issue: Raw yq commands scattered across files instead of using shared        â”‚ â”‚â”‚ â”‚ functions                                                                      â”‚ â”‚â”‚ â”‚ - Solution: Standardize on get_peer_config() from shared/utils.sh              â”‚ â”‚â”‚ â”‚                                                                                â”‚ â”‚â”‚ â”‚ 5. Redundant Utils Files                                                       â”‚ â”‚â”‚ â”‚                                                                                â”‚ â”‚â”‚ â”‚ - Files: vps/scripts/utils.sh and home/scripts/utils.sh                        â”‚ â”‚â”‚ â”‚ - Issue: Both just redirect to shared/utils.sh with minimal additions          â”‚ â”‚â”‚ â”‚ - Solution: Remove and update scripts to source shared/utils.sh directly       â”‚ â”‚â”‚ â”‚                                                                                â”‚ â”‚â”‚ â”‚ ğŸ› ï¸ Consolidation Action                                                        â”‚ â”‚
â”‚ â”‚                                                                                â”‚ â”‚â”‚ â”‚ Phase 1: Create Shared WireGuard Utilities                                     â”‚ â”‚â”‚ â”‚                                                                                â”‚ â”‚â”‚ â”‚ - Create shared/wireguard_utils.sh                                             â”‚ â”‚â”‚ â”‚ - Move add_peer_to_config, install_wireguard, setup_wireguard_directories      â”‚ â”‚â”‚ â”‚ functions                                                                      â”‚ â”‚â”‚ â”‚ - Parameterize functions to handle VPS vs Home differences                     â”‚ â”‚â”‚ â”‚                                                                                â”‚ â”‚â”‚ â”‚ Phase 2: Fix Logging Redundancy                                                â”‚ â”‚â”‚ â”‚                                                                                â”‚ â”‚â”‚ â”‚ - Remove duplicated log functions from tools/remove-site.sh and                â”‚ â”‚â”‚ â”‚ tools/status.sh                                                                â”‚ â”‚â”‚ â”‚ - Ensure all tools use shared logging functions consistently                   â”‚ â”‚â”‚ â”‚                                                                                â”‚ â”‚â”‚ â”‚ Phase 3: Standardize Configuration Parsing                                     â”‚ â”‚â”‚ â”‚                                                                                â”‚ â”‚â”‚ â”‚ - Replace inline yq commands with shared utility functions                     â”‚ â”‚â”‚ â”‚ - Ensure consistent error handling and fallback parsing                        â”‚ â”‚â”‚ â”‚                                                                                â”‚ â”‚â”‚ â”‚ Phase 4: Remove Redundant Utils Files                                          â”‚ â”‚â”‚ â”‚                                                                                â”‚ â”‚â”‚ â”‚ - Remove vps/scripts/utils.sh and home/scripts/utils.sh                        â”‚ â”‚â”‚ â”‚ - Update all scripts to source shared/utils.sh directly                        â”‚ â”‚â”‚ â”‚                                                                                â”‚ â”‚â”‚ â”‚ Phase 5: Code Review and Testing                                               â”‚ â”‚â”‚ â”‚                                                                                â”‚ â”‚â”‚ â”‚ - Verify all functionality works after consolidation                           â”‚ â”‚â”‚ â”‚ - Test both VPS and home setup scripts                                         â”‚ â”‚â”‚ â”‚ - Test all tools (add-site, remove-site, status, add-peer-key)                 â”‚ â”‚â”‚ â”‚                                                                                â”‚ â”‚â”‚ â”‚ ğŸ“Š Expected Benefits                                                           â”‚ â”‚â”‚ â”‚                                                                                â”‚ â”‚â”‚ â”‚ - Reduced Code: ~200-300 lines of duplicated code removed                      â”‚ â”‚â”‚ â”‚ - Better Maintainability: Single source of truth for shared functions          â”‚ â”‚â”‚ â”‚ - Consistency: All scripts use identical logic for common operations           â”‚ â”‚â”‚ â”‚ - Easier Debugging: Issues fixed in one place benefit all scripts              â”‚ â”‚â”‚ â”‚                                                                                â”‚ â”‚â”‚ â”‚ This plan will significantly clean up the codebase while maintaining all       â”‚ â”‚â”‚ â”‚ existing functionality.   